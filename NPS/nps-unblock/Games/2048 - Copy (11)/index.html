<script>
  (async function() {
    const loader = document.getElementById('loader');
    const errorDiv = document.getElementById('error-message');
    
    try {
      loader.style.display = 'block';
      const ruffle = window.RufflePlayer.newest();
      if (!ruffle) throw new Error('Ruffle failed to load');

      const player = ruffle.createPlayer();
      document.getElementById('game-container').appendChild(player);

      // DIRECT LOAD FOR TESTING - UNCOMMENT THIS
      // await player.load("2048.swf");
      // loader.style.display = 'none';
      // return;

      const swfFile = await detectSWF();
      console.log("Selected SWF file:", swfFile);
      
      if (!swfFile) throw new Error('No SWF found');
      
      player.addEventListener('loaded', () => {
        console.log("SWF loaded successfully");
        loader.style.display = 'none';
      });

      await player.load(swfFile);
    } catch (error) {
      console.error("Loading failed:", error);
      loader.style.display = 'none';
      errorDiv.textContent = `Error: ${error.message}`;
      errorDiv.style.display = 'block';
    }
  })();

  async function detectSWF() {
    console.log("Starting detection...");
    
    // Method 1: URL Parameter
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('swf')) {
      console.log("Found URL parameter SWF");
      return urlParams.get('swf');
    }

    // Method 2: Directory Listing
    try {
      console.log("Attempting directory listing...");
      const response = await fetch(window.location.href);
      const html = await response.text();
      const doc = new DOMParser().parseFromString(html, 'text/html');
      const swfLinks = Array.from(doc.querySelectorAll('a'))
        .map(a => a.href)
        .filter(href => href.endsWith('.swf'));
      
      console.log("Found SWF links:", swfLinks);
      
      if (swfLinks.length > 0) {
        console.log("Using directory listing SWF");
        return swfLinks[0];
      }
    } catch (error) {
      console.warn("Directory listing failed:", error);
    }

    // Method 3: Common Names
    console.log("Trying common filenames...");
    const commonNames = ['2048.swf', 'game.swf', 'main.swf'];
    for (const name of commonNames) {
      try {
        console.log("Checking for:", name);
        const response = await fetch(name);
        if (response.ok) {
          console.log("Found common name SWF:", name);
          return name;
        }
      } catch (e) {
        console.log("Failed to load:", name);
      }
    }

    return null;
  }
</script>
